%%==================================================
%% chapter04.tex for BIT Master Thesis
%% modified by yang yating
%% version: 0.1
%% last update: Dec 25th, 2016

%% modified by Meng Chao
%% version: 0.2
%% last update: May 29th, 2017
%%==================================================
\chapter{基于特征的单目半稠密SLAM算法}
\label{chap:Semi-Dense}

针对基于特征的单目SLAM算法重构地图稀疏，无法用于避障和路径规划的问题。本章在原有算法的基础上，参考直接法SLAM半稠密地图构建的原理，研究一种基于特征的单目半稠密SLAM算法。不同于直接法SLAM中使用连续多帧对参考帧逆深度进行滤波的做法，本文使用经过局部BA(Local BA)和回环pose图优化后的关键帧，在保证定位精度的基础上重构环境的半稠密地图。本章研究的基于特征的单目半稠密SLAM算法主要包括5个部分，立体搜索约束，极线搜索，逆深度假设融合，帧内逆深度假设一致性检验和帧间逆深度假设一致性检验，算法流程如图\ref{fig4.1}所示。具体步骤如下：
\begin{enumerate}[label={(\arabic*)}]

\item 对选取的关键帧$K_i$，提取图像中像素灰度梯度满足阈值的像素点，在临近的$N$个关键帧中进行极线搜索，得到像素的逆深度假设。

\item 考虑到图像在观测过程中存在噪声、视差过小和二义性等问题，假设像素逆深度服从高斯分布\upcite{[4.1]}，并认为相机关键帧的位姿是准确的，不考虑位姿的不确定性。

\item 由于关键帧之间的极线搜索是在宽基线条件下进行，搜索范围较大，需要考虑匹配过程中的误匹配。除考虑更多像素匹配约束外，采用高斯分布表示逆深度图中像素$p$的逆深度假设$N(\rho_p, \sigma_{\rho_p}^2)$，通过融合一致的逆深度假设降低误匹配的影响。

\item 对关键帧逆深度图中的像素逆深度进行融合，并且通过帧内逆深度假设一致性检验剔除与临近像素逆深度不一致的像素。

\item 完成当前关键帧和其相邻关键帧的逆深度假设计算后，对当前关键帧和相邻关键帧的像素逆深度进行一致性检验，剔除不一致的像素逆深度，并通过最小化深度误差函数优化像素深度。

\end{enumerate}

本章研究的基于特征的单目半稠密SLAM算法是在宽基线条件下进行极线搜索，容易导致误匹配产生离群值影响重构效果。因而相比于基于直接法的SLAM算法，进行极线搜索时除考虑灰度梯度大小和方向的匹配外，还应进行逆深度假设融合和帧内与帧间逆深度假设一致性检验，剔除宽基线极线搜索的误匹配点，从而提高重构效果。

\begin{figure}[h]
\centering
\includegraphics[scale=0.4,angle=-90]{figures/Fig4-1.pdf}
\caption{基于特征的半稠密单目SLAM算法流程图}
\label{fig4.1}
\end{figure}





% 4.1
\section{立体搜索约束}
基于特征的单目SLAM算法可以通过特征匹配与跟踪，提供准确的相机位姿$R,t$, 用于像素间的块匹配进而得到像素逆深度假设。由于已知当前关键帧ORB特征点的深度信息，可以估计当前关键帧的最大逆深度$\rho_{max}$， 最小逆深度$\rho_{min}$和像素逆深度的先验信息$N\left( \rho_0,\sigma_{\rho_0}^2  \right)$，其中$\rho_{max}=\rho_0+2\sigma_{\rho_0}$，$\rho_{min}=\rho_0-2\sigma_{\rho_0}$。另外，通过Covisibility图可以获得与当前关键帧$K_i$具有最多共视关系的前$N$个关键帧的集合$K$，从而完成关键帧间的立体搜索。在进行立体搜索求解当前关键帧的逆深度假设前，进行延时处理。一方面可以避免由于局部BA导致的共视图结构变化；另一方面可以引入之后时刻的关键帧，提高重建效果。


%4.2
\section{极线搜索}
对于当前关键帧$K_i$中像素梯度的模大于$\lambda_G$的像素$p$，会在关键帧$K_j \in K$的极线$l_j$上$\left[ \rho_{min}, \rho_{max} \right]$范围内进行搜索，寻找匹配的像素点，如图\ref{fig4.2}所示。极线利用基本矩阵$F_{ji}$求得，极线搜索方程为

\begin{equation}
\label{equ4.1}
x_j^T F_{ji}x_p = x^T_jl_j=0 \  \rightarrow \  v_j = m \cdot u_j+n
\end{equation}

\begin{figure}
\centering
\includegraphics[scale=0.2,angle=-90]{figures/Fig4-2.pdf}
\caption{极线搜索}
\label{fig4.2}
\end{figure}

不同于直接法SLAM中的窄极线匹配，本章的极线搜索是在宽基线下进行的，因而除了像素块匹配外，需要加入更多约束，除比较像素灰度$I$之外，还应考虑像素的梯度模$G$和梯度方向$\Uptheta$，从而在极线$l_j$上找到合适的像素匹配。根据以下约束\upcite{[4.2]}, 排除$l_j$极线上不满足条件的像素。


\begin{enumerate}[label={(\arabic*)}]

\item 关键帧$K_j \in K$上的匹配像素$p_j$应处于图像像素梯度大的区域，像素梯度应大于阈值，$G(u_j)> \lambda_G$。

\item 考虑到匹配的二义性与沿极线方向的像素梯度有关，因而匹配像素的梯度方向不能与极线方向垂直，满足$\vert \Uptheta(u_j)-\Uptheta_L \pm \pi \vert < \lambda_L$，其中$\Uptheta_L$表示基线方向。

\item 匹配像素$p_j$与$p$的梯度方向应该相近，满足$\vert \Uptheta(u_j)-(\Uptheta_L \pm \Delta \theta_{j,i}) \vert < \lambda_\theta $，其中$\Delta \theta_{j,i}$表示两帧图像之间的旋转角度。

\end{enumerate}
以上匹配约束可以剔除关键帧$K_j \in K$极线上$l_j$的大部分像素点，剩余的为关键帧$K_i$中的像素$p$可能的匹配点。为了比较两个像素点的相似性, 定义像素相似误差函数$e(u_j)$:
\begin{equation}
\label{equ4.2}
\begin{aligned}
& e(u_j) = {r_I^2 \over \sigma_I^2} + {r_G^2 \over \sigma_G^2} \\ 
& r_I = I_p-I(u_j),\  r_G = G_p-G(u_j)
\end{aligned}
\end{equation}
其中$r_I$和$r_G$表示像素间的灰度和梯度误差，$\sigma_I$和$\sigma_G$表示像素灰度和梯度的标准差。由于像素梯度是根据灰度计算得到，若利用施密特算子$\triangledown$计算梯度, 则像素灰度与梯度的误差具有相关性，
$\sigma_G^2=\theta \sigma_I^2$ , $ \theta = 0.23$，则公式\eqref{equ4.2}可以简化为：
\begin{equation}
\label{equ4.3}
 e(u_j) = \left( {r_I^2}+{1 \over \theta} r_G^2 \right) {1 \over \sigma_I^2}
\end{equation} 

使相似误差函数最小的像素$u_0$为像素$p$的匹配像素, 其灰度误差和梯度误差为$r_{I_0}$，$r_{G_0}$，相似误差函数的导数为
\begin{equation}
\label{equ4.4}
{\partial e \over \partial u_j } = -{ -2(r_I g+ { 1 \over \theta} r_G q )  \over \sigma_I^2 }
\end{equation}
其中$g$表示灰度梯度的模，$q$表示灰度梯度导数的模，方向与极线相同。
\begin{equation}
\label{equ4.5}
\begin{aligned}
& g \approx { {I(u_j+1) - I(u_j-1)} \over 2 } \\
& q \approx { {G(u_j+1) - G(u_j-1)} \over 2 } 
\end{aligned}
\end{equation}

令公式\eqref{equ4.4}等于$0$可以得到匹配像素$u_0$，实际情况下像素$u_0$是沿极线以像素为步长搜索得到的整数坐标像素，而公式\eqref{equ4.4}的解不一定为整数。设公式\eqref{equ4.4}的解为$u_0^*=u_0+\Delta u$，对方程\eqref{equ4.2}中的相似误差函数进行一阶泰勒展开，带入公式\eqref{equ4.4}并令其等于$0$，可以得到
\begin{equation}
\label{equ4.6}
\Delta u = {{ r_I(u_0) g(u_0)+ {1 \over \theta} r_G(u_0)q(u_0) } \over {g^2(u_0)+ { 1 \over \theta} q^2(u_0)}}
\end{equation}
匹配像素的亚像素精度为
\begin{equation}
\label{equ4.7}
u_0^* = u_0 + {{ r_I(u_0) g(u_0)+ {1 \over \theta} r_G(u_0)q(u_0) } \over {g^2(u_0)+ { 1 \over \theta} q^2(u_0)}}
\end{equation}
根据误差传递理论，可以得到匹配像素$u_0^*$的不确定性。
\begin{equation}
\label{equ4.8}
\sigma_{u_0^*}^2 = \left \vert { \partial u^* \over \partial r_I(u_0) }  \right \vert \sigma_I^2 + \left \vert { \partial u^* \over \partial r_G(u_0) }  \right \vert \sigma_G^2 = { \sigma_I^2 \over g^2(u_0) + {1 \over \theta} q^2(u_0) }
\end{equation}
根据像素不确定性可以知道，沿极线方向像素灰度梯度和像素灰度梯度导数的模越大，匹配的可靠性越高。

为了得到匹配像素的逆深度假设不确定性，需要计算当前关键帧$K_i$中像素$p$的逆深度$\rho_p$。对匹配像素进行三角化，有$s_jX_j = s_pR_{ji}X_p+t_{ji}, \  X_j = K^{-1}P_j, X_p = K^{-1}P_p$，可以得到像素逆深度为
\begin{equation}
\label{equ4.9}
\rho_p(u_j) = { r_z^{ji} X_p (u_j-c_x) - f_x r_x^{ji} X_p  \over - t_z^{ji}(u_j-c_x)+f_x t_x^{ji} }
\end{equation}
其中$r_x^{ji}$，$r_z^{ji}$表示两帧间的旋转矩阵$R_{ji}$的第一行和第三行，$t_x^{ji}$，$t_z^{ji}$表示来两帧间的平移向量$t_{ji}$的第一个和第三个元素；$f_x$，$c_x$是相机内参；$\rho_p = { 1 \over s_p}$，$P_j= \left [ u_j, v_j, 1 \right ] ^T$，利用方程\eqref{equ4.9}可以得到像素$p$的匹配像素$p_j$的逆深度假设$N(\rho_j, \sigma_{\rho_j}^2)$。
\begin{equation}
\label{equ4.10}
\begin{aligned}
 \rho_j &= \rho_p(u_0^*) \\ 
 \sigma_{\rho_j} &= max \left( \left \vert  \rho_p(u_0^*+\sigma_{u_0^*})-\rho_j \right \vert , \  \left \vert  \rho_p(u_0^*-\sigma_{u_0^*})-\rho_j \right \vert \right)
\end{aligned}
\end{equation}

在以上的逆深度假设不确定性的推导过程中，并没有像基于直接法SLAM一样引入帧间微小运动假设，因而本算法的逆深度假设不确定性具有一般性。


%4.3
\section{逆深度假设融合}
根据4.2节中的极线搜索方法，每个像素可以得到一组逆深度假设。由于存在极线像素逆深度立体搜索约束，且极线上匹配的像素需满足之前提到的像素匹配约束，因而逆深度假设的个数可能不足$N$个。另外，由于像素的相似性和遮挡，以上逆深度假设存在离群值。为了验证像素逆深度假设，在像素的一组逆深度假设中至少应该存在$\lambda_N$个一致假设。利用$\chi^2$假设检验(置信区间$95\%$，自由度2)，验证两个逆深度假设分布的一致性。
\begin{equation}
\label{equ4.11}
{ (\rho_a - \rho_b)^2 \over \sigma_a^2 }+{ (\rho_b - \rho_a)^2 \over \sigma_b^2} < 5.991
\end{equation}

每次从一组像素的逆深度假设中选取一个，与其他逆深度假设进行一致性检验，若与其一致的逆深度假设数量超过$\lambda_N$个，则对该组逆深度按照公式\eqref{equ4.12}进行融合\upcite{[4.3]}，像素$p$融合后的逆深度假设服从$N(\rho_p,\sigma_{\rho_p}^2)$，其中$n$表示通过检验的逆深度假设数量。
\begin{equation}
\label{equ4.12}
\rho_p = { {\sum\limits_n {1 \over \sigma_{\rho_j}^2} \rho_j } \over \sum\limits_n {1 \over \sigma_{\rho_j}^2}  }, \ 
\sigma_{\rho_p}^2 = {1 \over  \sum\limits_n { 1 \over \sigma_{\rho_j}^2}  }
\end{equation}


%4.4
\section{帧内逆深度假设一致性检验}
在完成当前关键帧$K_i$中像素的逆深度假设计算和融合后，需要对帧内所有逆深度假设进行一致性检验，用于剔除像素逆深度假设中的离群值。首先，通过公式\eqref{equ4.11}检验某像素和它临近的8个像素点的逆深度假设的一致性，若一致的逆深度假设数量多于2个，则保留该像素点的逆深度假设，否则剔除。若保留该像素，其逆深度根据公式\eqref{equ4.12}进行融合，不确定性为所有参与逆深度假设检验的像素中的最小不确定性。对于处于像素灰度变化明显区域但没有逆深度假设的像素点，若在该像素周围至少有两个逆深度假设一致的像素，则给该像素点添加逆深度假设，逆深度为附近一致逆深度假设的逆深度均值，不确定性是附近一致逆深度假设中的最小值，该方法可以增加地图重建的稠密性，起到平滑地图的作用。

%4.5
\section{帧间逆深度假设一致性检验}
在当前关键帧$K_i$的$N$个临近关键帧的逆深度地图全部计算完成后，对关键帧$K_i$中像素的逆深度假设进行帧间一致性检验。对于关键帧$K_i$中的像素$p$对应的逆深度$\rho_p$，将其投影到$K_i$临近的关键帧$K_j \in K$中，并计算像素$p$在关键帧$K_j \in K$中对应点的逆深度：
\begin{equation}
\label{equ4.13}
\begin{aligned}
& x_j = K R_{ji} {1 \over \rho_p} X_p + Kt_{ji} \\ 
& \rho_j = { \rho_p \over r_z^{ji}X_p+\rho_p t_z^{ji} }
\end{aligned}
\end{equation}
其中$x_{j}$表示关键帧$K_i$中的像素$p$在$K_j \in K$中对应点的像素坐标。若$x_j$的像素坐标不是整数，搜索$x_{j}$临近的4个像素，通过$\chi^2$假设检验(置信区间$95\%$，自由度$1$)，检验是否与$x_j$逆深度假设一致。
\begin{equation}
\label{equ4.14}
{ (\rho_j - \rho_{j,n})^2 \over \sigma_{\rho_{j,n}}^2 } < 3.84
\end{equation}

如果在$\rho_{j,n}$中存在与$x_j$逆深度假设一致的像素点，则可以保留像素点$x_j$的逆深度假设。如果在当前关键帧$K_i$的$N$个临近关键帧中至少有$\lambda_N$个关键帧可以保留像素点$x_j$的逆深度假设，则保留当前关键帧$K_i$中像素$p$的逆深度假设。

最后对关键帧像素深度进行优化，以深度$d_p = { 1 \over \rho_p }$为优化变量，利用公式\eqref{equ4.15}通过高斯-牛顿方法最小化深度误差函数，优化像素点的深度，提高重构精度。
\begin{equation}
\label{equ4.15}
d_p^* = \min_{d_p} \sum\limits_{j,n} \left( d_{j,n} - d_p r_z^{ji} X_p - t_z^{ji}  \right)^2  {1 \over {d_{j,n}^4 \sigma_{\rho_{j,n}}^2 }}
\end{equation}
目标优化函数选择深度作为优化变量而不是逆深度，是因为在方程\eqref{equ4.13}中以深度作为变量时，深度误差函数是线性的。


\section{实验}
本节验证上文研究的基于特征的单目半稠密SLAM算法，根据算法在TUM数据集下的实验结果，从定位精度、逆深度一致性检验对地图重构的影响和地图重建效果三个方面与基于直接法的LSD-SLAM进行比较。所有实验实时运行在处理器$i7-4720$，内存$8G$的笔记本计算机上，操作系统选用Ubuntu 14.04，算法由C++实现。实验中算法参数设置为$N=7$，$\sigma_I=20$，$\lambda_G=8$，$\lambda_L = 80^\circ$，$\lambda_\theta=45^\circ$，$\lambda_N=4$。

\subsection{定位精度}
选择TUM数据集中的5个具有代表性的场景，每个场景定位精度取5次实验结果的均值，与基于特征的ORB-SLAM、基于直接法的LSD-SLAM进行比较，实验结果如下表\ref{tab4.1}所示。

\begin{table}[h]		%表格环境
% \multicolumn是跨列功能，第一个参数2，表示跨两列，第二个参数c|，表示文字置中，并在栏位右边画一条直线框，最后一个参数即是要填入的文字
%\multirow是跨行功能，第一个参数2，表示跨两行，第二个参数*，表示系统自动调整文字，最后一个参数即是要填入的文字
%\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}		%单元格内容强制换行
\renewcommand\arraystretch{1.5}		%增加行间距
\centering
\caption{轨迹定位精度}   % 表格标题，在表格内容之前
\label{tab4.1}
	\begin{tabular*}{0.9\textwidth}{@{\extracolsep{\fill}}cccc}  %生成行和列的表格
	%\begin{tabular}{p{2cm}p{1.5cm}p{1.5cm}p{1.5cm}}	
	
	\toprule
	
	\multicolumn{1}{c}{\multirow{2}{*}{Seq.}} &
	\multicolumn{3} {c} {\bfseries\tabincell{c} {关键帧轨迹均方根误差 RMSE(cm)}} \\
	\cline{2-4}								%在上一行下面，2-4列画横线
	\multicolumn{1}{c}{}&
	\multicolumn{1}{c}{ORB-SLAM}	&
	\multicolumn{1}{c}{LSD-SLAM}	&
	\multicolumn{1}{c}{改进算法}		\\	
	
	\midrule
	
	
	\multicolumn{1}{c}{fr2/desk}	&
	\multicolumn{1}{c}{0.88}		&
	\multicolumn{1}{c}{4.57}		&
	\multicolumn{1}{c}{0.85}		\\
	
	\multicolumn{1}{c}{fr2/desk\_ person}	&
	\multicolumn{1}{c}{0.63}		&
	\multicolumn{1}{c}{31.73}		&
	\multicolumn{1}{c}{0.77}		\\

	\multicolumn{1}{c}{fr3/nostructure\_ texture\_ near}	&
	\multicolumn{1}{c}{1.39}		&
	\multicolumn{1}{c}{7.54}		&
	\multicolumn{1}{c}{1.51}		\\		
	
	\multicolumn{1}{c}{fr3/structure\_ texture\_ near}	&
	\multicolumn{1}{c}{1.58}		&
	\multicolumn{1}{c}{8.63}		&
	\multicolumn{1}{c}{1.47}		\\	
	
	\multicolumn{1}{c}{fr3/long\_ office}	&
	\multicolumn{1}{c}{3.45}		&
	\multicolumn{1}{c}{38.53}		&
	\multicolumn{1}{c}{3.53}		\\

	\bottomrule
	
	\end{tabular*}
\end{table}

通过表\ref{tab4.1}的实验结果可以发现，在相同的测试条件和场景下，改进后的基于特征的单目半稠密SLAM算法定位精度与基于特征的ORB-SLAM算法接近，均好于基于直接法的LSD-SLAM算法。主要原因可能是改进后的基于特征的单目半稠密SLAM算法继承了基于特征的SLAM算法的优点，利用特征跟踪和匹配的方法估计位姿，具有较好的鲁棒性和视角不变性，后端进行地图与关键帧位姿的联合优化，提高了定位精度。

\subsection{逆深度一致性检验对地图重构的影响}
本章研究基于特征的单目半稠密SLAM算法，其半稠密地图重构是在宽基线的关键帧间进行的，如果单纯使用直接法SLAM中的像素块匹配，会导致重构的半稠密地图包含很多离群值，重构精度和效果较差。本文引入地图点云的逆深度一致性检验(见本文4.4，4.5节)，剔除由于宽基线重构产生的地图点云离群值，并对地图进行了平滑处理。图\ref{fig4.3}展示采用逆深度一致性检验前后的重构效果。

\begin{figure}[h]
    \centering
       	  \subfigure[逆深度一致性检验前]
       	  {
          \includegraphics[scale=1]{figures/Fig4-3_a.pdf}                    
          }                    
          \subfigure[逆深度一致性检验后]
       	  {
          \includegraphics[scale=1]{figures/Fig4-3_b.pdf}
          }
     \caption{逆深度一致性检验对地图重构的影响}
\label{fig4.3}
\end{figure}

实验结果表明，逆深度一致性检验可以有效的剔除由于宽基线关键帧极线搜索产生的地图点云离群值，并对地图起到平滑作用，显著提高半稠密地图的重构效果。

\subsection{地图重建效果}
本实验与基于直接法的LSD-SLAM比较地图重构效果。选择TUM RGB-D数据集中的3个场景fr2/desk，fr3/nostructure\_ texture\_ near\_ with\_ loop，fr3/long\_ office\_ household进行测试，实验结果如下图所示。

根据实验结果可以发现，在图\ref{fig4.4}和\ref{fig4.6}中，相比于LSD-SLAM，本章研究改进的基于特征的单目半稠密SLAM算法重构地图含有较少的地图点云离群值，且轮廓清晰，可以通过重构地图识别出对应的物体。此外，在图\ref{fig4.6}的测试场景中，LSD-SLAM有时会发生跟踪丢失的情况，而本章的改进算法可以正常运行，保证较好的重构效果。但从图\ref{fig4.5}可以看出，LSD-SLAM在部分环境细节的地图重构上要好于本章的改进算法，可通过适当调整改进算法中的逆深度一致性检验的置信区间，提高重构地图的稠密性。


\begin{figure}[h]
    \centering
       	  \subfigure[改进算法]
       	  {
          \includegraphics[scale=1]{figures/Fig4-4_a.pdf}                    
          }                    
          \subfigure[LSD-SLAM]
       	  {
          \includegraphics[scale=0.7]{figures/Fig4-4_b.pdf}
          }
     \caption{fr2/desk场景}
\label{fig4.4}
\end{figure}

\begin{figure}[H]
    \centering
       	  \subfigure[改进算法]
       	  {
          \includegraphics[scale=0.8]{figures/Fig4-5_a.pdf}                    
          }                    
          \subfigure[LSD-SLAM]
       	  {
          \includegraphics[scale=0.6]{figures/Fig4-5_b.pdf}
          }
     \caption{fr3/nostructure\_ texture\_ near\_ with\_ loop场景}
\label{fig4.5}
\end{figure}



\begin{figure}[h]
    \centering
       	  \subfigure[改进算法]
       	  {
          \includegraphics[scale=1]{figures/Fig4-6_a.pdf}                    
          }                    
          \subfigure[LSD-SLAM]
       	  {
          \includegraphics[scale=0.8]{figures/Fig4-6_b.pdf}
          }
     \caption{fr3/long\_ office\_ household场景}
\label{fig4.6}
\end{figure}


\section{本章小结}
本章研究的基于特征的单目半稠密SLAM算法，采用像素块匹配和基于概率的逆深度假设，可以在CPU下实时完成定位与环境地图的半稠密重构。与基于直接法的SLAM不同，选用经过局部BA或回环pose图优化后的关键帧，在宽基线条件下对关键帧中像素梯度较大区域进行极线搜索获取逆深度假设，之后通过逆深度假设融合、一致性检验得到环境的半稠密地图。通过实验可以发现，相比于基于直接法的SLAM算法，本章研究的基于特征的单目半稠密SLAM算法定位精度高，具有良好的旋转不变性、视角不变性和鲁棒性，可以重构得到用于无人机避障和路径规划的半稠密环境地图。



